---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { marked } from 'marked';
import { generateResponsiveImageHtml, type ImageInfo } from '../utils/responsive-image';
import { getReadingTime } from '../utils/reading-time';
import { getHighlighter } from '../utils/shiki';

export async function getStaticPaths() {
  const posts = await getCollection('posts');

  return posts
    .filter((post) => post.data.published)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props;
const { data, body, slug } = post;
const readingTime = getReadingTime(body);

// Get all posts for "related posts"
const allPosts = (await getCollection('posts')).filter((p) => p.data.published && p.slug !== slug);

const relatedPosts = allPosts
  .map((p) => ({
    slug: p.data.slug ?? p.slug,
    title: p.data.title,
    date: p.data.date,
    cover: p.data.cover,
    score: (data.tags ?? []).filter((t: string) => (p.data.tags ?? []).includes(t)).length,
  }))
  .filter((p) => p.score > 0)
  .sort((a, b) => b.score - a.score || b.date.getTime() - a.date.getTime())
  .slice(0, 4);

// Initialize Shiki highlighter (cached across pages)
const highlighter = await getHighlighter();

// Cover image srcset helper
function getCoverSrcset(cover: string) {
  const match = cover.match(/^(.+)-(\d+)\.(\w+)$/);
  if (!match) return null;
  const [, base, , ext] = match;
  return {
    src: `${base}-768.${ext}`,
    srcset: `${base}-320.${ext} 320w, ${base}-480.${ext} 480w, ${base}-768.${ext} 768w, ${base}-1200.${ext} 1200w`,
  };
}
const coverData = data.cover ? getCoverSrcset(data.cover) : null;

// Extract headings for TOC
const headings: { depth: number; text: string; id: string }[] = [];
const renderer = new marked.Renderer();
const imageData: ImageInfo[] = [];

function escapeHtml(str: string) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

renderer.heading = ({ text, depth }: { text: string; depth: number }) => {
  const id = text
    .toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-');
  if (depth >= 2 && depth <= 3) {
    headings.push({ depth, text, id });
  }
  return `<h${depth} id="${escapeHtml(id)}">${escapeHtml(text)}</h${depth}>`;
};

renderer.code = ({ text, lang }: { text: string; lang?: string }) => {
  const language = lang || 'text';
  const loadedLangs = highlighter.getLoadedLanguages();
  let highlighted: string;

  if (loadedLangs.includes(language)) {
    highlighted = highlighter.codeToHtml(text, {
      lang: language,
      themes: { light: 'github-light', dark: 'github-dark' },
    });
  } else {
    highlighted = highlighter.codeToHtml(text, {
      lang: 'text',
      themes: { light: 'github-light', dark: 'github-dark' },
    });
  }

  const displayLang = language === 'text' ? '' : language;
  return `<div class="code-block">${displayLang ? `<div class="code-lang">${displayLang}</div>` : ''}<button class="code-copy" aria-label="Copy code"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>${highlighted}</div>`;
};

renderer.image = ({ href, text }: { href: string; text: string }) => {
  const match = href.match(/\/images\/posts\/([^/]+)\/(.+)-768\.webp/);
  if (match) {
    const [, postSlug, imageName] = match;
    imageData.push({ postSlug, imageName, alt: text });
    return `<!--IMG:${imageData.length - 1}-->`;
  }
  return `<img src="${escapeHtml(href)}" alt="${escapeHtml(text)}" loading="lazy" />`;
};

marked.setOptions({ renderer });
let htmlContent = await marked(body);

imageData.forEach((img, index) => {
  const imgTag = generateResponsiveImageHtml(img, slug);
  htmlContent = htmlContent.replace(`<!--IMG:${index}-->`, imgTag);
});
---

<BaseLayout
  title={data.title}
  description={data.description}
  image={data.cover || undefined}
  ogType="article"
  publishedTime={data.date.toISOString()}
  tags={data.tags}
  preloadImage={coverData ? { src: coverData.src, srcset: coverData.srcset } : undefined}
>
  <div class="-mt-8 md:-mt-12">
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'BreadcrumbList',
        itemListElement: [
          { '@type': 'ListItem', position: 1, name: 'Home', item: 'https://phucle.dev/' },
          {
            '@type': 'ListItem',
            position: 2,
            name: data.title,
            item: `https://phucle.dev/${slug}/`,
          },
        ],
      })}
    />
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'BlogPosting',
        headline: data.title,
        description: data.description,
        datePublished: data.date.toISOString(),
        author: { '@type': 'Person', name: 'Phuc Le', url: 'https://phucle.dev/about' },
        publisher: { '@type': 'Person', name: 'Phuc Le', url: 'https://phucle.dev' },
        mainEntityOfPage: { '@type': 'WebPage', '@id': `https://phucle.dev/${slug}/` },
        url: `https://phucle.dev/${slug}/`,
        ...(data.cover ? { image: `https://phucle.dev${data.cover}` } : {}),
        wordCount: body.trim().split(/\s+/).length,
        keywords: (data.tags ?? []).join(', '),
      })}
    />
    {
      coverData ? (
        <header class="relative -mx-4 mb-8 md:-mx-6 md:mb-12">
          <figure class="relative overflow-hidden">
            <img
              src={coverData.src}
              srcset={coverData.srcset}
              sizes="100vw"
              alt={data.title}
              width="768"
              height="403"
              fetchpriority="high"
              class="cover-image aspect-[5/2] w-full object-cover md:aspect-[3/1]"
            />
            <div class="absolute inset-0 bg-black/60" />
            <div class="absolute inset-0 flex flex-col items-center justify-center px-6 text-center md:px-8">
              <h1 class="mb-3 text-2xl font-medium tracking-tighter text-white md:text-3xl">
                {data.title}
              </h1>
              <div class="flex items-center gap-2 text-xs text-white/90 md:text-sm">
                <time datetime={data.date.toISOString()}>
                  {data.date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
                <span>&middot;</span>
                <span>{readingTime} min read</span>
              </div>
            </div>
          </figure>
        </header>
      ) : (
        <header class="mb-8 md:mb-12">
          <h1 class="mb-3 text-2xl font-medium tracking-tighter text-gray-900 dark:text-gray-100 md:mb-4 md:text-3xl">
            {data.title}
          </h1>
          <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500 md:text-sm">
            <time datetime={data.date.toISOString()}>
              {data.date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </time>
            <span>&middot;</span>
            <span>{readingTime} phút đọc</span>
          </div>
        </header>
      )
    }
    <article>
      <div class="lg:grid lg:grid-cols-[1fr_14rem] lg:gap-12">
        <div>
          {
            headings.length > 1 && (
              <nav class="mb-6 rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-gray-800 dark:bg-gray-900 md:mb-8 md:p-4 lg:hidden">
                <h2 class="mb-2 text-xs font-medium text-gray-900 dark:text-gray-100 md:text-sm">
                  Table of Contents
                </h2>
                <ul class="space-y-1 md:space-y-1.5">
                  {headings.map((h) => (
                    <li class={h.depth === 2 ? '' : 'ml-3'}>
                      <a
                        href={`#${h.id}`}
                        class={`'text-gray-600 dark:hover:text-gray-100' } block text-xs leading-relaxed transition-colors hover:text-gray-900 dark:text-gray-400 md:text-sm`}
                      >
                        {h.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            )
          }

          <div
            class="prose max-w-none dark:prose-invert prose-headings:scroll-mt-20 prose-headings:font-medium prose-headings:tracking-tight prose-headings:text-gray-900 prose-p:text-gray-700 prose-a:text-gray-900 prose-a:underline prose-a:decoration-gray-300 prose-a:underline-offset-2 hover:prose-a:decoration-gray-900 prose-strong:font-medium prose-strong:text-gray-900 dark:prose-headings:text-gray-100 dark:prose-p:text-gray-300 dark:prose-a:text-gray-100 dark:prose-a:decoration-gray-700 dark:hover:prose-a:decoration-gray-100 dark:prose-strong:text-gray-100"
            set:html={htmlContent}
          />
        </div>

        {
          headings.length > 1 && (
            <aside class="hidden lg:block">
              <nav class="sticky top-20">
                <h2 class="mb-3 text-sm font-medium text-gray-900 dark:text-gray-100">
                  Table of Contents
                </h2>
                <ul class="space-y-1.5">
                  {headings.map((h) => (
                    <li class={h.depth === 2 ? '' : 'ml-3'}>
                      <a
                        href={`#${h.id}`}
                        data-toc-id={h.id}
                        class={`toc-link 'text-gray-600 dark:hover:text-gray-100' } block text-sm leading-relaxed transition-colors hover:text-gray-900 dark:text-gray-400`}
                      >
                        {h.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </aside>
          )
        }
      </div>
    </article>

    {
      relatedPosts.length > 0 && (
        <section class="mt-16 border-t border-gray-200 pt-12 dark:border-gray-800">
          <h2 class="mb-6 text-sm font-medium text-gray-500 dark:text-gray-500">Related Posts</h2>
          <div class="grid gap-3 sm:grid-cols-2">
            {relatedPosts.map((rp) => {
              const coverMatch = rp.cover?.match(/^(.+)-(\d+)\.(\w+)$/);
              const thumbSrc = coverMatch ? `${coverMatch[1]}-320.${coverMatch[3]}` : null;
              return (
                <a
                  href={`/${rp.slug}`}
                  class="group flex gap-3 overflow-hidden rounded-lg border border-gray-200 p-3 transition-colors hover:border-gray-400 dark:border-gray-800 dark:hover:border-gray-600"
                >
                  {thumbSrc && (
                    <div class="h-20 w-20 shrink-0 overflow-hidden rounded bg-gray-100 dark:bg-gray-900">
                      <img
                        src={thumbSrc}
                        alt={rp.title}
                        width="80"
                        height="80"
                        loading="lazy"
                        decoding="async"
                        class="h-full w-full object-cover"
                      />
                    </div>
                  )}
                  <div class="flex min-w-0 flex-1 flex-col justify-center gap-1">
                    <h3 class="line-clamp-2 text-sm font-medium text-gray-900 dark:text-gray-100">
                      {rp.title}
                    </h3>
                    <time
                      datetime={rp.date.toISOString()}
                      class="text-xs text-gray-500 dark:text-gray-500"
                    >
                      {rp.date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </time>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      )
    }

    <section class="mt-16 border-t border-gray-200 pt-12 dark:border-gray-800">
      <h2 class="mb-6 text-sm font-medium text-gray-500 dark:text-gray-500">Comments</h2>
      <div id="giscus-container"></div>
      <script is:inline>
        (function () {
          var theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
          var s = document.createElement('script');
          s.src = 'https://giscus.app/client.js';
          s.setAttribute('data-repo', 'lupmit/phucle.dev');
          s.setAttribute('data-repo-id', 'R_kgDORJeppA');
          s.setAttribute('data-category', 'Comments');
          s.setAttribute('data-category-id', 'DIC_kwDORJeppM4C2AFh');
          s.setAttribute('data-mapping', 'pathname');
          s.setAttribute('data-strict', '0');
          s.setAttribute('data-reactions-enabled', '1');
          s.setAttribute('data-emit-metadata', '0');
          s.setAttribute('data-input-position', 'top');
          s.setAttribute('data-theme', theme);
          s.setAttribute('data-lang', 'en');
          s.setAttribute('data-loading', 'lazy');
          s.setAttribute('crossorigin', 'anonymous');
          s.async = true;
          document.getElementById('giscus-container').appendChild(s);
        })();
      </script>
    </section>

    <div class="mt-12">
      <a
        href="/"
        class="inline-flex items-center gap-1.5 text-sm text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100"
      >
        <svg
          class="h-3.5 w-3.5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
        </svg>
        Back to home
      </a>
    </div>
  </div>
</BaseLayout>

<style is:global>
  .prose img {
    border-radius: 0.25rem;
  }

  @media (max-width: 768px) {
    .prose img,
    .cover-image {
      width: 100vw;
      max-width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      border-radius: 0;
    }

    figure:has(.cover-image) {
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      width: 100vw;
      max-width: 100vw;
      border-radius: 0;
    }
  }

  /* Inline code */
  .prose code:not(pre code) {
    background: #f5f5f5;
    border: 1px solid #e5e5e5;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-weight: 400;
    word-break: break-word;
  }

  .dark .prose code:not(pre code) {
    background: #171717;
    border-color: #262626;
  }

  /* Code block container */
  .code-block {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid #e5e5e5;
  }

  .dark .code-block {
    border-color: #262626;
  }

  /* Language label */
  .code-lang {
    position: absolute;
    top: 0;
    right: 3rem;
    padding: 0.25rem 0.75rem;
    font-size: 0.6875rem;
    font-family: 'Inter Variable', 'Inter', sans-serif;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #737373;
    background: #fafafa;
    border-bottom-left-radius: 0.25rem;
    border-bottom-right-radius: 0.25rem;
    user-select: none;
    z-index: 1;
  }

  .dark .code-lang {
    color: #a3a3a3;
    background: #0a0a0a;
  }

  /* Copy button */
  .code-copy {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.375rem;
    border-radius: 0.25rem;
    background: transparent;
    color: #a3a3a3;
    border: none;
    cursor: pointer;
    opacity: 0;
    transition:
      opacity 0.15s,
      background-color 0.15s,
      color 0.15s;
    z-index: 1;
  }

  .code-block:hover .code-copy {
    opacity: 1;
  }

  .code-copy:hover {
    background: #f5f5f5;
    color: #525252;
  }

  .dark .code-copy:hover {
    background: #262626;
    color: #e5e5e5;
  }

  .code-copy.copied {
    opacity: 1;
    color: #22c55e;
  }

  /* Shiki pre/code styling */
  .code-block pre {
    margin: 0 !important;
    padding: 1rem !important;
    border-radius: 0 !important;
    border: none !important;
    font-size: 0.875rem !important;
    line-height: 1.6 !important;
    overflow-x: auto;
    tab-size: 2;
  }

  .code-block pre code {
    font-family:
      'JetBrains Mono', ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
    font-size: inherit;
    background: none !important;
    padding: 0 !important;
    border: none !important;
  }

  /* Shiki dual theme */
  .dark .shiki,
  .dark .shiki span {
    color: var(--shiki-dark) !important;
    background-color: var(--shiki-dark-bg) !important;
  }

  .prose blockquote {
    border-left: 2px solid #e5e5e5;
    padding-left: 1rem;
    font-style: normal;
    color: #737373;
  }

  .dark .prose blockquote {
    border-left-color: #262626;
    color: #a3a3a3;
  }

  .toc-link.active {
    color: #171717 !important;
    font-weight: 500;
  }

  .dark .toc-link.active {
    color: #f5f5f5 !important;
  }
</style>

<script>
  // Sync Giscus theme with dark mode
  function updateGiscusTheme() {
    const isDark = document.documentElement.classList.contains('dark');
    const theme = isDark ? 'dark' : 'light';
    const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
    if (iframe) {
      iframe.contentWindow?.postMessage({ giscus: { setConfig: { theme } } }, 'https://giscus.app');
    }
  }

  const observer = new MutationObserver(() => updateGiscusTheme());
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

  // Copy code button
  document.querySelectorAll('.code-copy').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const block = btn.closest('.code-block');
      const code = block?.querySelector('pre code')?.textContent ?? '';
      await navigator.clipboard.writeText(code);
      btn.classList.add('copied');
      btn.innerHTML =
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
      setTimeout(() => {
        btn.classList.remove('copied');
        btn.innerHTML =
          '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';
      }, 2000);
    });
  });

  // TOC active heading highlight
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
  if (tocLinks.length > 0) {
    const headingIds = Array.from(tocLinks).map((l) => l.dataset.tocId!);
    const headingEls = headingIds
      .map((id) => document.getElementById(id))
      .filter(Boolean) as HTMLElement[];

    const updateActive = () => {
      let activeId = '';
      const threshold = 100; // Distance from top of viewport

      // Find the last heading that has scrolled past the threshold
      for (const el of headingEls) {
        const rect = el.getBoundingClientRect();
        if (rect.top < threshold) {
          activeId = el.id;
        } else {
          break;
        }
      }

      // Only highlight the exact active heading
      tocLinks.forEach((link) => {
        link.classList.toggle('active', link.dataset.tocId === activeId);
      });
    };

    window.addEventListener('scroll', updateActive, { passive: true });
    updateActive();
  }
</script>
