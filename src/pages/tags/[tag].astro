---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';
import { getReadingTime } from '../../utils/reading-time';

export async function getStaticPaths() {
  const posts = (await getCollection('posts')).filter((post) => post.data.published);

  const tags = new Set<string>();
  posts.forEach((post) => {
    (post.data.tags ?? []).forEach((tag: string) => tags.add(tag.toLowerCase()));
  });

  return [...tags].map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => (post.data.tags ?? []).some((t: string) => t.toLowerCase() === tag))
        .map((post) => ({
          slug: post.data.slug ?? post.slug,
          title: post.data.title,
          date: post.data.date,
          description: post.data.description,
          tags: post.data.tags ?? [],
          cover: post.data.cover,
          readingTime: getReadingTime(post.body),
          originalTag: (post.data.tags ?? []).find((t: string) => t.toLowerCase() === tag),
        }))
        .sort((a, b) => b.date.getTime() - a.date.getTime()),
    },
  }));
}

const { tag, posts } = Astro.props;
const displayTag = posts[0]?.originalTag ?? tag;
---

<BaseLayout title={`Tag: ${displayTag}`} description={`Bài viết có tag "${displayTag}"`}>
  <div class="mb-8">
    <a
      href="/"
      class="mb-4 inline-flex items-center gap-1.5 text-sm text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100"
    >
      <svg
        class="h-3.5 w-3.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"
        ></path>
      </svg>
      Back to all posts
    </a>
    <h1
      class="text-xl font-semibold leading-tight tracking-tighter text-gray-900 dark:text-gray-100 sm:text-3xl md:text-4xl md:leading-tight"
    >
      <span class="text-gray-500 dark:text-gray-500">#</span>{displayTag}
    </h1>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-500">{posts.length} posts</p>
  </div>

  <div
    class="grid gap-4"
    style="grid-template-columns: repeat(auto-fill, minmax(min(100%, 310px), 1fr));"
  >
    {posts.map((post) => <PostCard {...post} />)}
  </div>
</BaseLayout>
