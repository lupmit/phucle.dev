---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getReadingTime } from '../../utils/reading-time';

export async function getStaticPaths() {
  const posts = (await getCollection('posts')).filter((post) => post.data.published);

  const tags = new Set<string>();
  posts.forEach((post) => {
    (post.data.tags ?? []).forEach((tag: string) => tags.add(tag.toLowerCase()));
  });

  return [...tags].map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => (post.data.tags ?? []).some((t: string) => t.toLowerCase() === tag))
        .map((post) => ({
          slug: post.data.slug ?? post.slug,
          title: post.data.title,
          date: post.data.date,
          description: post.data.description,
          tags: post.data.tags ?? [],
          cover: post.data.cover,
          readingTime: getReadingTime(post.body),
          originalTag: (post.data.tags ?? []).find((t: string) => t.toLowerCase() === tag),
        }))
        .sort((a, b) => b.date.getTime() - a.date.getTime()),
    },
  }));
}

const { tag, posts } = Astro.props;
const displayTag = posts[0]?.originalTag ?? tag;
---

<BaseLayout title={`Tag: ${displayTag}`} description={`Bài viết có tag "${displayTag}"`}>
  <div class="mb-8">
    <a
      href="/"
      class="mb-4 inline-flex items-center gap-1.5 text-sm text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100"
    >
      <svg
        class="h-3.5 w-3.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"
        ></path>
      </svg>
      Back to all posts
    </a>
    <h1 class="text-2xl font-medium tracking-tight text-gray-900 dark:text-gray-100">
      <span class="text-gray-500 dark:text-gray-500">#</span>{displayTag}
    </h1>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-500">{posts.length} posts</p>
  </div>

  <div
    class="grid gap-4"
    style="grid-template-columns: repeat(auto-fill, minmax(min(100%, 310px), 1fr));"
  >
    {
      posts.map((post) => {
        const coverMatch = post.cover?.match(/^(.+)-(\d+)\.(\w+)$/);
        const thumbSrc = coverMatch ? `${coverMatch[1]}-480.${coverMatch[3]}` : null;
        return (
          <a
            href={`/${post.slug}`}
            class="group flex flex-col overflow-hidden rounded-lg border border-gray-200 transition-colors hover:border-gray-400 dark:border-gray-800 dark:hover:border-gray-600"
          >
            {thumbSrc && (
              <div class="aspect-[2/1] overflow-hidden bg-gray-100 dark:bg-gray-900">
                <img
                  src={thumbSrc}
                  alt={post.title}
                  width="480"
                  height="240"
                  loading="lazy"
                  decoding="async"
                  class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                />
              </div>
            )}
            <div class="flex flex-1 flex-col p-5">
              <time
                datetime={post.date.toISOString()}
                class="mb-2 text-xs text-gray-500 dark:text-gray-500"
              >
                {post.date.toLocaleDateString('vi-VN', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </time>
              <h2 class="mb-2 text-base font-medium text-gray-900 dark:text-gray-100">
                {post.title}
              </h2>
              {post.description && (
                <p class="mb-3 line-clamp-2 text-sm text-gray-600 dark:text-gray-400">
                  {post.description}
                </p>
              )}
              <div class="mt-auto flex items-center gap-2">
                <span class="text-xs text-gray-500 dark:text-gray-500">
                  {post.readingTime} phút đọc
                </span>
                {post.tags.length > 0 && (
                  <div class="flex gap-1.5">
                    {post.tags.slice(0, 2).map((tag: string) => (
                      <span class="rounded bg-gray-100 px-1.5 py-0.5 text-xs text-gray-600 dark:bg-gray-900 dark:text-gray-400">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </a>
        );
      })
    }
  </div>
</BaseLayout>
