---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Search" description="Search posts on phucle.dev" noindex={true}>
  <div class="mb-10">
    <h1
      class="mb-6 text-xl font-semibold leading-tight tracking-tighter text-gray-900 dark:text-gray-100 sm:text-3xl md:text-4xl md:leading-tight"
    >
      Search
    </h1>
    <div class="relative">
      <svg
        class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 dark:text-gray-600"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path>
      </svg>
      <input
        id="search-input"
        type="text"
        placeholder="Search by content, title..."
        autocomplete="off"
        class="w-full rounded border border-gray-200 bg-white py-2 pl-10 pr-4 text-sm text-gray-900 outline-none transition-colors placeholder:text-gray-400 focus:border-gray-400 dark:border-gray-800 dark:bg-black dark:text-gray-100 dark:placeholder:text-gray-600 dark:focus:border-gray-600"
      />
    </div>
  </div>

  <div id="search-results"></div>
  <div id="no-results" class="hidden py-12 text-center text-sm text-gray-500 dark:text-gray-500">
    No posts found.
  </div>
  <div id="initial-state" class="py-12 text-center text-sm text-gray-500 dark:text-gray-500">
    Enter keywords to search.
  </div>
</BaseLayout>

<script is:inline>
  var searchInput = document.getElementById('search-input');
  var searchResults = document.getElementById('search-results');
  var noResults = document.getElementById('no-results');
  var initialState = document.getElementById('initial-state');
  var pagefind;

  async function loadPagefind() {
    if (pagefind) return;
    try {
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
    } catch (e) {
      console.warn(
        'Pagefind not available. Run "npm run build" first, then use "npm run preview".',
      );
      noResults.textContent = 'Search not ready. Run build before using preview.';
      noResults.classList.remove('hidden');
      initialState.classList.add('hidden');
      throw e;
    }
  }

  var debounceTimer;

  searchInput.addEventListener('input', function () {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(doSearch, 200);
  });

  async function doSearch() {
    var query = searchInput.value.trim();

    if (!query) {
      searchResults.innerHTML = '';
      noResults.classList.add('hidden');
      initialState.classList.remove('hidden');
      return;
    }

    await loadPagefind();
    var search = await pagefind.search(query);
    var results = await Promise.all(
      search.results.slice(0, 10).map(function (r) {
        return r.data();
      }),
    );

    initialState.classList.add('hidden');

    if (results.length === 0) {
      searchResults.innerHTML = '';
      noResults.classList.remove('hidden');
      return;
    }

    noResults.classList.add('hidden');
    searchResults.innerHTML = results
      .map(function (result) {
        return (
          '<a href="' +
          result.url +
          '" class="group -mx-3 mb-3 flex flex-col gap-1 px-3 py-2 transition-colors hover:bg-gray-50 dark:hover:bg-gray-950">' +
          '<span class="text-gray-900 underline decoration-gray-300 decoration-1 underline-offset-2 transition-colors group-hover:decoration-gray-900 dark:text-gray-100 dark:decoration-gray-700 dark:group-hover:decoration-gray-100">' +
          (result.meta.title || 'Untitled') +
          '</span>' +
          '<p class="line-clamp-2 text-sm text-gray-600 dark:text-gray-400">' +
          result.excerpt +
          '</p>' +
          '</a>'
        );
      })
      .join('');
  }

  searchInput.focus();
</script>

<style is:global>
  #search-results mark {
    background-color: rgb(229 229 229);
    color: inherit;
    border-radius: 2px;
    padding: 0 2px;
  }

  .dark #search-results mark {
    background-color: rgb(38 38 38);
  }
</style>
