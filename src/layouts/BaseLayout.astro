---
import '../styles/global.css';
import '../styles/search.css';
import '@fontsource/be-vietnam-pro/latin-400.css';
import '@fontsource/be-vietnam-pro/latin-500.css';
import '@fontsource/be-vietnam-pro/latin-600.css';
import '@fontsource/jetbrains-mono/latin-400.css';

const {
  title,
  description,
  image,
  ogType,
  publishedTime,
  tags = [],
  noindex = false,
  preloadImage,
} = Astro.props;

const site = Astro.site ?? new URL(Astro.url.origin);
const canonicalUrl = new URL(Astro.url.pathname, site).toString();
const pageTitle = title ? `${title} | phucle.dev` : 'phucle.dev';
const metaDescription = description ?? 'Tech blog - Sharing knowledge and programming experience';
const ogImageUrl = new URL(image ?? '/og-default.webp', site).toString();
const ogImageAlt = title ?? 'phucle.dev';

const navLinks = [
  { href: '/', label: 'Blog' },
  { href: '/about', label: 'About' },
];
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="icon"
      href="/favicon-light.ico"
      sizes="16x16 32x32 48x48 64x64 128x128 256x256"
      media="(prefers-color-scheme: light)"
    />
    <link
      rel="icon"
      href="/favicon.ico"
      sizes="16x16 32x32 48x48 64x64 128x128 256x256"
      media="(prefers-color-scheme: dark)"
    />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="generator" content={Astro.generator} />
    <link rel="preconnect" href="https://github.githubassets.com" crossorigin />
    <link rel="preconnect" href="https://giscus.app" crossorigin />

    {
      preloadImage && (
        <link
          rel="preload"
          as="image"
          href={preloadImage.src}
          imagesrcset={preloadImage.srcset}
          imagesizes="(max-width: 768px) calc(100vw - 48px), 720px"
          type="image/webp"
        />
      )
    }

    <title>{pageTitle}</title>
    <meta name="description" content={metaDescription} />
    <meta name="robots" content={noindex ? 'noindex,nofollow' : 'index,follow'} />
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:type" content={ogType ?? 'website'} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="phucle.dev" />
    <meta property="og:locale" content="vi_VN" />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:alt" content={ogImageAlt} />
    <meta property="og:image:type" content="image/webp" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="author" content="Phuc Le" />

    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {ogType === 'article' && <meta property="article:author" content="https://phucle.dev/about" />}
    {tags.map((tag: string) => <meta property="article:tag" content={tag} />)}

    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="alternate" type="application/rss+xml" title="phucle.dev" href="/rss.xml" />

    <script is:inline>
      const theme = localStorage.getItem('theme');
      if (
        theme === 'dark' ||
        (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
      }
    </script>
  </head>
  <body
    class="min-h-screen bg-white font-sans text-base text-gray-700 antialiased dark:bg-black dark:text-gray-300"
  >
    <header
      class="sticky top-0 z-50 border-b border-gray-200 bg-white backdrop-blur-lg dark:border-gray-800 dark:bg-black"
    >
      <nav class="mx-auto flex h-16 max-w-6xl items-center justify-between px-4 md:px-6">
        <a href="/" class="flex items-center">
          <img
            src="/logo.webp"
            srcset="/logo.webp 1x, /logo@2x.webp 2x"
            alt="phucle.dev"
            width="200"
            height="43"
            class="h-7 w-auto object-contain object-left dark:hidden"
          />
          <img
            src="/logo-dark.webp"
            srcset="/logo-dark.webp 1x, /logo-dark@2x.webp 2x"
            alt="phucle.dev"
            width="200"
            height="43"
            class="hidden h-7 w-auto object-contain object-left mix-blend-normal dark:block"
            style="-webkit-color-correction: sRGB;"
          />
        </a>

        <div class="hidden items-center gap-1 sm:flex">
          {
            navLinks.map((link) => (
              <a
                href={link.href}
                class:list={[
                  'flex items-center px-3 py-2 text-sm font-medium transition-colors',
                  Astro.url.pathname === link.href ||
                  (link.href !== '/' && Astro.url.pathname.startsWith(link.href))
                    ? 'text-gray-900 dark:text-gray-100'
                    : 'text-gray-500 hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100',
                ]}
              >
                {link.label}
              </a>
            ))
          }
          <button
            id="theme-toggle"
            class="ml-2 p-1.5 text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100"
            aria-label="Toggle dark mode"
          >
            <svg
              class="h-4 w-4 dark:hidden"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
              ></path>
            </svg>
            <svg
              class="hidden h-4 w-4 dark:block"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
              ></path>
            </svg>
          </button>
        </div>

        <div class="flex items-center gap-2 sm:hidden">
          <button
            id="theme-toggle-mobile"
            class="p-1.5 text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100"
            aria-label="Toggle dark mode"
          >
            <svg
              class="h-4 w-4 dark:hidden"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
              ></path>
            </svg>
            <svg
              class="hidden h-4 w-4 dark:block"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
              ></path>
            </svg>
          </button>
          <button
            id="mobile-menu-btn"
            class="p-1.5 text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100"
            aria-label="Menu"
          >
            <svg
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5"
              ></path>
            </svg>
          </button>
        </div>
      </nav>
    </header>

    <div
      id="mobile-drawer-overlay"
      class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm transition-opacity sm:hidden"
    >
    </div>

    <div
      id="mobile-drawer"
      class="fixed right-0 top-0 z-50 h-full w-64 translate-x-full transform border-l border-gray-200 bg-white transition-transform duration-300 dark:border-gray-800 dark:bg-black sm:hidden"
    >
      <div class="flex h-16 items-center justify-end px-6">
        <button
          id="mobile-drawer-close"
          class="p-1.5 text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-100"
          aria-label="Close menu"
        >
          <svg
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <nav class="flex flex-col gap-1 px-4">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                'rounded px-3 py-2 text-sm font-medium transition-colors',
                Astro.url.pathname === link.href ||
                (link.href !== '/' && Astro.url.pathname.startsWith(link.href))
                  ? 'bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100'
                  : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900 dark:text-gray-500 dark:hover:bg-gray-950 dark:hover:text-gray-100',
              ]}
            >
              {link.label}
            </a>
          ))
        }
      </nav>
    </div>

    <main class="mx-auto max-w-6xl px-4 py-6 pb-8 md:px-6 md:py-8 md:pb-12">
      <slot />
    </main>

    <footer class="border-t border-gray-200 dark:border-gray-800">
      <div class="mx-auto max-w-6xl px-4 py-8 md:px-6 md:py-12">
        <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-500">
          <p>
            &copy; {new Date().getFullYear()} phucle.dev
          </p>
          <div class="flex items-center gap-6">
            <a
              href="/rss.xml"
              class="transition-colors hover:text-gray-900 dark:hover:text-gray-100"
            >
              RSS
            </a>
            <a
              href="https://github.com/lupmit"
              target="_blank"
              rel="noopener noreferrer me"
              aria-label="GitHub"
              class="transition-colors hover:text-gray-900 dark:hover:text-gray-100"
            >
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                ></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <button
      id="scroll-top"
      class="fixed bottom-8 right-4 z-50 hidden rounded-full border border-gray-200 bg-white p-2 text-gray-500 shadow-sm transition-colors hover:text-gray-900 dark:border-gray-800 dark:bg-black dark:text-gray-500 dark:hover:text-gray-100 md:right-8"
      aria-label="Scroll to top"
    >
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
      </svg>
    </button>

    <script>
      function updateThemeColor() {
        const isDark = document.documentElement.classList.contains('dark');
        const themeColor = isDark ? '#000000' : '#ffffff';
        document.querySelectorAll('meta[name="theme-color"]').forEach((tag) => tag.remove());

        const metaTag = document.createElement('meta');
        metaTag.name = 'theme-color';
        metaTag.content = themeColor;
        document.head.appendChild(metaTag);
      }

      function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeColor();
      }

      // Update theme color on page load
      updateThemeColor();

      document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
      document.getElementById('theme-toggle-mobile')?.addEventListener('click', toggleTheme);

      // Mobile drawer
      const mobileDrawer = document.getElementById('mobile-drawer');
      const mobileDrawerOverlay = document.getElementById('mobile-drawer-overlay');
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileDrawerClose = document.getElementById('mobile-drawer-close');

      function openDrawer() {
        mobileDrawer?.classList.remove('translate-x-full');
        mobileDrawerOverlay?.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      function closeDrawer() {
        mobileDrawer?.classList.add('translate-x-full');
        mobileDrawerOverlay?.classList.add('hidden');
        document.body.style.overflow = '';
      }

      mobileMenuBtn?.addEventListener('click', openDrawer);
      mobileDrawerClose?.addEventListener('click', closeDrawer);
      mobileDrawerOverlay?.addEventListener('click', closeDrawer);

      // Scroll to top
      const scrollBtn = document.getElementById('scroll-top')!;
      window.addEventListener(
        'scroll',
        () => {
          scrollBtn.classList.toggle('hidden', window.scrollY < 400);
        },
        { passive: true },
      );
      scrollBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    </script>
  </body>
</html>
