---
import '../styles/fonts.css';
import '@fontsource/jetbrains-mono/latin-400.css';
import '@fontsource/jetbrains-mono/vietnamese-400.css';
import '@fontsource/jetbrains-mono/latin-500.css';
import '@fontsource/jetbrains-mono/vietnamese-500.css';

import interLatin from '@fontsource-variable/inter/files/inter-latin-wght-normal.woff2?url';
import interViet from '@fontsource-variable/inter/files/inter-vietnamese-wght-normal.woff2?url';

const {
  title,
  description,
  image,
  ogType,
  publishedTime,
  tags = [],
  noindex = false,
  preloadImage,
} = Astro.props;

const site = Astro.site ?? new URL(Astro.url.origin);
const canonicalUrl = new URL(Astro.url.pathname, site).toString();
const pageTitle = title ? `${title} | phucle.dev` : 'phucle.dev';
const metaDescription =
  description ?? 'Blog công nghệ - Chia sẻ kiến thức và kinh nghiệm lập trình';
const ogImageUrl = new URL(image ?? '/og-default.webp', site).toString();
const ogImageAlt = title ?? 'phucle.dev';

const navLinks = [
  { href: '/', label: 'Blog' },
  { href: '/tags', label: 'Tags' },
  { href: '/search', label: 'Search' },
  { href: '/about', label: 'About' },
];
---

<!doctype html>
<html lang="vi" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" sizes="16x16 32x32 48x48 64x64 128x128 256x256" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="generator" content={Astro.generator} />

    <link rel="preload" as="font" type="font/woff2" href={interLatin} crossorigin />
    <link rel="preload" as="font" type="font/woff2" href={interViet} crossorigin />

    {
      preloadImage && (
        <link
          rel="preload"
          as="image"
          href={preloadImage.src}
          imagesrcset={preloadImage.srcset}
          imagesizes="(max-width: 768px) calc(100vw - 48px), 720px"
          type="image/webp"
        />
      )
    }

    <title>{pageTitle}</title>
    <meta name="description" content={metaDescription} />
    <meta name="robots" content={noindex ? 'noindex,nofollow' : 'index,follow'} />
    <meta name="theme-color" content="#2563eb" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1e3a5f" media="(prefers-color-scheme: dark)" />
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:type" content={ogType ?? 'website'} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="phucle.dev" />
    <meta property="og:locale" content="vi_VN" />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:alt" content={ogImageAlt} />
    <meta property="og:image:type" content="image/webp" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="author" content="Phuc Le" />

    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {ogType === 'article' && <meta property="article:author" content="https://phucle.dev/about" />}
    {tags.map((tag: string) => <meta property="article:tag" content={tag} />)}

    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="alternate" type="application/rss+xml" title="phucle.dev" href="/rss.xml" />

    <!-- Dark mode: prevent flash -->
    <script is:inline>
      const theme = localStorage.getItem('theme');
      if (
        theme === 'dark' ||
        (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
      }
    </script>
  </head>
  <body
    class="min-h-screen bg-white font-sans text-gray-900 antialiased dark:bg-gray-950 dark:text-gray-100"
  >
    <!-- Header -->
    <header
      class="sticky top-0 z-50 border-b border-gray-200 bg-white/80 backdrop-blur-lg dark:border-gray-800 dark:bg-gray-950/80"
    >
      <nav class="mx-auto flex max-w-3xl items-center justify-between px-6 py-4">
        <a href="/" class="flex items-center">
          <img
            src="/logo.webp"
            srcset="/logo.webp 1x, /logo@2x.webp 2x"
            alt="phucle.dev"
            width="200"
            height="50"
            class="h-8 w-auto dark:hidden"
          />
          <img
            src="/logo-dark.webp"
            srcset="/logo-dark.webp 1x, /logo-dark@2x.webp 2x"
            alt="phucle.dev"
            width="200"
            height="50"
            class="hidden h-8 w-auto dark:block"
          />
        </a>

        <!-- Desktop nav -->
        <div class="hidden items-center gap-1 sm:flex">
          {
            navLinks.map((link) => (
              <a
                href={link.href}
                class:list={[
                  'rounded-lg px-3 py-2 text-sm font-medium transition-colors',
                  Astro.url.pathname === link.href ||
                  (link.href !== '/' && Astro.url.pathname.startsWith(link.href))
                    ? 'bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-white'
                    : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white',
                ]}
              >
                {link.label}
              </a>
            ))
          }
          <button
            id="theme-toggle"
            class="ml-2 rounded-lg p-2 text-gray-600 transition-colors hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800"
            aria-label="Toggle dark mode"
          >
            <svg
              class="h-5 w-5 dark:hidden"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
              ></path>
            </svg>
            <svg
              class="hidden h-5 w-5 dark:block"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Mobile menu button -->
        <div class="flex items-center gap-2 sm:hidden">
          <button
            id="theme-toggle-mobile"
            class="rounded-lg p-2 text-gray-600 transition-colors hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800"
            aria-label="Toggle dark mode"
          >
            <svg
              class="h-5 w-5 dark:hidden"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
              ></path>
            </svg>
            <svg
              class="hidden h-5 w-5 dark:block"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
              ></path>
            </svg>
          </button>
          <button
            id="mobile-menu-btn"
            class="rounded-lg p-2 text-gray-600 transition-colors hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800"
            aria-label="Menu"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5"
              ></path>
            </svg>
          </button>
        </div>
      </nav>

      <!-- Mobile menu -->
      <div
        id="mobile-menu"
        class="hidden border-t border-gray-200 px-6 pb-4 dark:border-gray-800 sm:hidden"
      >
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                'block rounded-lg px-3 py-2 text-sm font-medium transition-colors',
                Astro.url.pathname === link.href ||
                (link.href !== '/' && Astro.url.pathname.startsWith(link.href))
                  ? 'bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-white'
                  : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white',
              ]}
            >
              {link.label}
            </a>
          ))
        }
      </div>
    </header>

    <main class="mx-auto max-w-3xl px-6 py-10">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-200 dark:border-gray-800">
      <div class="mx-auto max-w-3xl px-6 py-10">
        <div class="flex flex-col items-center justify-between gap-4 sm:flex-row">
          <p class="text-sm text-gray-500 dark:text-gray-400">
            &copy; {new Date().getFullYear()} phucle.dev
          </p>
          <div class="flex items-center gap-4">
            <a
              href="/rss.xml"
              class="text-sm text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
            >
              RSS
            </a>
            <a
              href="https://github.com/lupmit"
              target="_blank"
              rel="noopener noreferrer me"
              aria-label="GitHub"
              class="text-gray-500 transition-colors hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
            >
              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                ></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Scroll to top -->
    <button
      id="scroll-top"
      class="fixed bottom-6 right-6 z-50 hidden rounded-full border border-gray-200 bg-white p-2.5 text-gray-500 shadow-lg transition-all hover:text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-400 dark:hover:text-white"
      aria-label="Scroll to top"
    >
      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
      </svg>
    </button>

    <!-- Scripts -->
    <script>
      function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      }

      document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
      document.getElementById('theme-toggle-mobile')?.addEventListener('click', toggleTheme);

      document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
        document.getElementById('mobile-menu')?.classList.toggle('hidden');
      });

      // Scroll to top
      const scrollBtn = document.getElementById('scroll-top')!;
      window.addEventListener(
        'scroll',
        () => {
          scrollBtn.classList.toggle('hidden', window.scrollY < 400);
        },
        { passive: true },
      );
      scrollBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    </script>
  </body>
</html>
